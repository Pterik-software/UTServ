unit DeactivatePlanForm;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.Buttons, Data.DB,
  MemDS, DBAccess, Uni, Vcl.Grids, Vcl.DBGrids, Vcl.Mask, Vcl.DBCtrls;

type
  TFormDeactivatePlan = class(TForm)
    BitBtnClose: TBitBtn;
    DBGrid1: TDBGrid;
    BitBtnSave: TBitBtn;
    UniDataSource1: TDataSource;
    Label1: TLabel;
    DBEdit1: TDBEdit;
    Label2: TLabel;
    EditChangeReason: TEdit;
    UniSQLUpdateActivePlan: TUniSQL;
    UniSQLActivePlans: TUniQuery;
    UniSQLActivePlansbusiness_id: TStringField;
    UniSQLActivePlansitem_name: TStringField;
    UniSQLActivePlanslang_item_name: TStringField;
    UniSQLActivePlansis_active_locally: TBooleanField;
    UniSQLActivePlanslng_active_locally: TStringField;
    UniSQLActivePlansis_active_server: TBooleanField;
    UniSQLActivePlanslng_active_server: TStringField;
    UniSQLActivePlansreason_deactivated: TStringField;
    UniSQLActivePlansupdated_by: TStringField;
    UniSQLActivePlansupdated_datetime: TDateTimeField;
    UniSQLActivePlanslog_changes: TStringField;
    procedure BitBtnCloseClick(Sender: TObject);
    procedure BitBtnSaveClick(Sender: TObject);
  private
    { Private declarations }
  public
    procedure SetFormValues(const Business_id:integer);
  end;

var
  FormDeactivatePlan: TFormDeactivatePlan;

implementation

{$R *.dfm}
uses System.UITypes, DateUtils, DataModule;

procedure TFormDeactivatePlan.BitBtnSaveClick(Sender: TObject);
begin
if length(EditChangeReason.Text)<10 then
  begin
  MessageDlg('Введите причину изменения, не менее 10 символов', mtError, [mbOk],0);
  exit;
  end;
UniSQLUpdateActivePlan.Prepare;
UniSQLUpdateActivePlan.ParamByName('p_business_id').Value:= UniSQLActivePlans['business_id'];
UniSQLUpdateActivePlan.ParamByName('p_reason').Value:= EditChangeReason.Text;
UniSQLUpdateActivePlan.ParamByName('p_log').Value:= 'Изменено пользователем '+DM.CurrentUser+':'+DateTimeToStr(Now()) ;
UniSQLUpdateActivePlan.ParamByName('p_log').Value:= 'Изменено пользователем '+DM.CurrentUser+':'+DateTimeToStr(Now()) ;
UniSQLUpdateActivePlan.ParamByName('p_log').Value:= 'Изменено пользователем '+DM.CurrentUser+':'+DateTimeToStr(Now()) ;
UniSQLUpdateActivePlan.Execute;
MessageDlg('Сохранено', mtInformation, [mbOk],0);
Close;
end;

procedure TFormDeactivatePlan.SetFormValues(const Business_id:integer);
begin
EditChangereason.Text:='';
if not UniSQLActivePlans.Active then UniSQLActivePlans.Active:=true;
if not UniSQLActivePlans.Active then UniSQLActivePlans.Active:=true;
while not UniSQLActivePlans.EOF do
  begin
  if UniSQLActivePlans['business_id']=Business_id then exit;
  UniSQLActivePlans.next;
  end;

end;

procedure TFormDeactivatePlan.BitBtnCloseClick(Sender: TObject);
begin
Close;
end;

end.
